// Комплексный тест для извлечения названий моделей
// Использует общую логику из pattern-extractor

import {
  extractModelNameFromCertificate,
  clearReferenceCache,
} from './src/modules/parser/utils/pattern-extractor';

function testExtractModelNameFromCertificate(certificateName) {
  if (!certificateName) return '';

  console.log(`\nTesting: "${certificateName}"`);

  const result = extractModelNameFromCertificate(certificateName);
  if (!result) {
    return '';
  }

  if (result.matched && result.normalizedName) {
    console.log(
      `✅ Matched with pattern "${result.patternName}": "${result.normalizedName}"`,
    );
    return result.normalizedName;
  } else {
    console.log(`❌ No pattern matched`);
    return '';
  }
}

// Тестовые случаи
const testCases = [
  {
    input:
      'Система ультразвуковая диагностическая EPIQ с принадлежностями варианты исполнения:  EPIQ I. Система ультразвуковая диагностическая EPIQ в варианте исполнения EPIQ, РЗН 2014/2234',
    expected: 'EPIQ',
  },
  {
    input:
      'Аппарат ультразвуковой диагностический многофункциональный MyLab, вариант исполнения: MyLab Omega с принадлежностями',
    expected: 'MyLab Omega',
  },
  {
    input:
      'Система ультразвуковая диагностическая EPIQ Elite с принадлежностями',
    expected: 'EPIQ Elite',
  },
  {
    input: 'MyLab X8 eXP с принадлежностями',
    expected: 'MyLab X8 eXP',
  },
  {
    input:
      'Система ультразвуковая диагностическая медицинская Vivid iq с принадлежностями, вариант исполнения: Система ультразвуковая диагностическая медицинская  Vivid iq Premium console, производства ДжиИ Медикал Системз (Китай) Ко., Лтд., Китай (РЗН 2017/6506)',
    expected: 'Vivid iq Premium console',
  },
  {
    input:
      'РЗН 2020/13006 Система ультразвуковая диагностическая медицинская «РуСкан 70П» по ТУ 26.60.12-004-98204792-2020 с принадлежностями',
    expected: 'РуСкан 70П',
  },
  {
    input:
      'Система ультразвуковая диагностическая медицинская Vivid iq Premium console',
    expected: 'Vivid iq Premium console',
  },
  {
    input:
      'РЗН 2020/13006 Система ультразвуковая диагностическая медицинская "РуСкан 70П" по ТУ 26.60.12-004-98204792-2020 с принадлежностямиБазовый состав:1.Электронная консоль в составе с функциональными модулями управления, монитором, панелью управления, пластиковым корпусом, производства фирмы АО «НПО «СКАНЕР», Россия, или производства фирмы SAMSUNG MEDISON CO.LTD., Республика Корея - 1 шт.2.Программное обеспечение для управления ультразвуковым сканером, посредством русскоязычного интерфейса «РуСкан 70П версия 3.00.08», производства фирмы ЗАО "Медиэйс", Россия. - 1 шт.',
    expected: 'РуСкан 70П',
  },
  {
    input:
      'Система ультразвуковая диагностическая, вариант исполнения V7-RUS, производитель «САМСУНГ МЕДИСОН КО., ЛТД.» , Республика Корея. Ультразвуковой диагностический аппарат HM70A-RUS с принадлежностями. Производитель: «Самсунг Медисон КО.,ЛТД» Республика Корея, Samsung Medison Co., LTD., 3366, Hanseo-ro, Nam-myeon, Hongcheon-gun, Gangwon-do, 25108,Republic of Korea. Страна происхождения товара Республика Корея',
    expected: 'HM70A-RUS',
  },
  {
    input:
      'Система ультразвуковая диагностическая Aloka Arietta 850 с принадлежностями, производитель «ФУДЖИФИЛЬМ Хелскеа Корпорэйшн», Япония',
    expected: 'Aloka Arietta 850',
  },
  {
    input:
      'Система ультразвуковая диагностическая, вариант исполнения V7-RUS, производитель «САМСУНГ МЕДИСОН КО., ЛТД.» , Республика Корея',
    expected: 'V7-RUS',
  },
  {
    input:
      'Система ультразвуковая диагностическая медицинская с Logiq E10 c принадлежностями',
    expected: 'Logiq E10',
  },
  {
    input: 'Система ультразвуковая цифровая цветовая доплеровская CHISON',
    expected: 'CHISON',
  },
  {
    input:
      'РЗН 2021/15918, I Сканер ультразвуковой диагностический "СмартСкан" ("SmartScan") по ТУ 26.60.12-001-56312059-2019варианты исполнения: IСканер ультразвуковой диагностический "СмартСкан 15А", исполнение 00',
    expected: 'СмартСкан 15А',
  },
  {
    input:
      'Система ультразвуковая диагностическая медицинская Venue Go с принадлежностями, производства "ДжиИ Медикал Системз Ультрасаунд и Праймери Кэа Диагностик, ЛЛС", Соединенные Штаты Америки (РЗН 2021/15705)',
    expected: 'Venue Go',
  },
  {
    input:
      'Система ультразвуковая диагностическая W9-RUS с принадлежностями, производитель "САМСУНГ МЕДИСОН КО., ЛТД.", Республика Корея (РЗН 2022/17720)',
    expected: 'W9-RUS',
  },
  {
    input:
      'Система ультразвуковой визуализации универсальная серии EM7 с принадлежностями по ТУ 26.60.12-003-39346393-2021, в составе: Система ультразвуковой визуализации универсальная серии ЕМ7 с принадлежностями, вариант исполнения: ЕМ7 Ехр по ТУ 26.60.12-003-39346393-2021',
    expected: 'EM7',
  },
  {
    input:
      'Система ультразвуковой визуализации универсальная серии ЕМ7 с принадлежностями по ТУ 26.60.12-003-39346393-2021, в составе: Система ультразвуковой визуализации универсальная серии ЕМ7 с принадлежностями, вариант исполнения: ЕМ7 Ехр по ТУ 26.60.12-003-39346393-2021',
    expected: 'EM7',
  },
  {
    input:
      'Система ультразвуковая диагностическая медицинская "РуСкан 65" по ТУ 26.60.12-003-98204792-2019 с принадлежностями',
    expected: 'РуСкан 65',
  },
  {
    input: 'Система ультразвуковая цифровая цветовая доплеровская CHISON',
    expected: 'CHISON',
  },
  {
    input:
      'Система ультразвуковая диагностическая, вариант исполнения V7-RUS, "САМСУНГ МЕДИСОН КО., ЛТД."',
    expected: 'V7-RUS',
  },
  {
    input:
      'Система ультразвуковой визуализации универсальная серии ЕМ7, вариант исполнения: ЕM7Exp с принадлежностями по ТУ 26.60.12-003-39346393-2021',
    expected: 'EM7',
  },
  {
    input:
      'Система диагностическая ультразвуковая Acclarix с принадлежностями,  вариант исполнения: Система диагностическая ультразвуковая U60',
    expected: 'U60',
  },
  {
    input:
      'Система ультразвуковая диагностическая медицинская Vivid iq с принадлежностями вариант исполнения: 1.2. Система ультразвуковая диагностическая медицинская Vivid iq Premium console',
    expected: 'Vivid iq Premium console',
  },
];

console.log('=== КОМПЛЕКСНЫЙ ТЕСТ ИЗВЛЕЧЕНИЯ НАЗВАНИЙ МОДЕЛЕЙ ===\n');

testCases.forEach((testCase, index) => {
  console.log(`\n--- Тест ${index + 1} ---`);
  console.log(`Ожидается: "${testCase.expected}"`);
  const result = testExtractModelNameFromCertificate(testCase.input);
  console.log(`Результат: "${result}"`);
  console.log(
    `Статус: ${result === testCase.expected ? '✅ УСПЕХ' : '❌ ОШИБКА'}`,
  );
});

// Детальный анализ конкретного случая с EM7
console.log('\n=== ДЕТАЛЬНЫЙ АНАЛИЗ СЛУЧАЯ EM7 ===');
const em7TestCase = "Система ультразвуковой визуализации универсальная серии EM7 с принадлежностями по ТУ 26.60.12-003-39346393-2021, в составе: Система ультразвуковой визуализации универсальная серии ЕМ7 с принадлежностями, вариант исполнения: ЕМ7 Ехр по ТУ 26.60.12-003-39346393-2021";

console.log(`\nТестовая строка: ${em7TestCase}`);

// Проверим какие паттерны срабатывают
const patterns = [
  {
    pattern: /универсальная\s+серии\s+([A-Za-zА-Яа-я0-9\s\-\.ёЁ]+?)(?:\s+с\s+принадлежностями|\s*,|$)/gi,
    name: 'универсальная серии'
  },
  {
    pattern: /вариант\s+исполнения:\s*([A-Za-z0-9\s\-\.]+?)(?:\s+с\s+принадлежностями|\s*,|$)/gi,
    name: 'вариант исполнения с двоеточием'
  }
];

patterns.forEach(({pattern, name}) => {
  let match;
  pattern.lastIndex = 0; // Reset regex
  while ((match = pattern.exec(em7TestCase)) !== null) {
    console.log(`Паттерн "${name}" нашел: "${match[1]}" на позиции ${match.index}`);
  }
});

console.log('\nРезультат extractModelNameFromCertificate:');
const em7Result = extractModelNameFromCertificate(em7TestCase);
console.log(em7Result);

// Детальный анализ случая Acclarix/U60
console.log('\n=== ДЕТАЛЬНЫЙ АНАЛИЗ СЛУЧАЯ ACCLARIX/U60 ===');
const acclarixTestCase = "Система диагностическая ультразвуковая Acclarix с принадлежностями,  вариант исполнения: Система диагностическая ультразвуковая U60";

console.log(`\nТестовая строка: ${acclarixTestCase}`);

console.log('\nРезультат extractModelNameFromCertificate:');
const acclarixResult = extractModelNameFromCertificate(acclarixTestCase);
console.log(acclarixResult);
